/**
 * @file Firebase Security Rules for iBarangay System (Multi-Barangay)
 * @description This ruleset enforces a user-ownership model for residents and their document requests,
 *               with multi-barangay support. Users can only access data from their assigned barangay,
 *               unless they are super admins.
 *
 * Data Structure:
 * - /users/{userId}: Stores user accounts with 'role' and 'barangayId' fields.
 * - /residents/{residentId}: Stores resident profiles, scoped by barangayId.
 * - /documentRequests/{documentRequestId}: Stores document requests, scoped by barangayId.
 * - /payments/{paymentId}: Stores payment information, scoped by barangayId.
 * - /officials/{officialId}: Stores barangay officials, scoped by barangayId.
 * - /barangays/{barangayId}: Stores barangay configuration and information.
 *
 * Key Security Decisions:
 * - All data is scoped by barangayId for multi-tenancy.
 * - Users can only access data from their assigned barangay.
 * - Super admins (isSuperAdmin == true) can access all barangays.
 * - Residents can only read/write their own data within their barangay.
 * - Staff can manage data within their assigned barangay.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData(uid) {
      let userDoc = get(/databases/$(database)/documents/users/$(uid));
      if (userDoc.data == null) {
        return null;
      }
      return userDoc.data;
    }

    function getUserRole(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.role : "";
    }

    function getUserBarangayId(uid) {
      let userData = getUserData(uid);
      return userData != null ? userData.barangayId : "";
    }

    function isSuperAdmin() {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData != null && userData.isSuperAdmin == true;
    }

    /**
     * @description Checks if the authenticated user has the "Admin" role.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == "Admin";
    }

    /**
     * @description Checks if the authenticated user is a staff member (not a "Resident").
     */
    function isStaff() {
      let role = getUserRole(request.auth.uid);
      return isSignedIn() && role != "Resident" && role != "";
    }

    /**
     * @description Checks if the resource belongs to the user's barangay or if user is super admin.
     */
    function isSameBarangay(resourceBarangayId) {
      return isSuperAdmin() || getUserBarangayId(request.auth.uid) == resourceBarangayId;
    }

    /**
     * @description Checks if the incoming data has the correct barangayId.
     */
    function hasValidBarangayId() {
      return isSuperAdmin() || 
        (request.resource.data.barangayId == getUserBarangayId(request.auth.uid));
    }
    
    /**
     * @description Rules for the /barangays/{barangayId} collection.
     */
    match /barangays/{barangayId} {
      // Allow any authenticated user to read their assigned barangay
      allow get: if isSignedIn();
      allow list: if isSuperAdmin();
      allow create: if true; // Allow creation during initial setup
      allow update: if isSuperAdmin() || (isAdmin() && isSameBarangay(barangayId));
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /users/{userId} collection.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isStaff() || isSuperAdmin();
      allow create: if true; 
      allow update: if isSuperAdmin() || isAdmin() || isOwner(userId);
      allow delete: if isSuperAdmin() || isAdmin() || isOwner(userId);
    }

    /**
     * @description Rules for the /residents/{residentId} collection.
     */
    match /residents/{residentId} {
      allow get: if (isStaff() && isSameBarangay(resource.data.barangayId)) || isOwner(residentId);
      allow list: if isStaff() && (isSuperAdmin() || 
        request.query.limit == 1 || 
        isSameBarangay(resource.data.barangayId));
      allow create: if hasValidBarangayId();
      allow update: if (isStaff() && isSameBarangay(resource.data.barangayId)) || isOwner(residentId);
      allow delete: if isStaff() && isSameBarangay(resource.data.barangayId);
    }

    /**
     * @description Rules for the /documentRequests/{documentRequestId} collection.
     */
    match /documentRequests/{documentRequestId} {
      allow list: if isStaff() && isSameBarangay(resource.data.barangayId);
      allow get: if (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        (resource.data.residentId == request.auth.uid);
      allow create: if request.resource.data.residentId == request.auth.uid && hasValidBarangayId();
      allow update: if (isStaff() && isSameBarangay(resource.data.barangayId)) || 
        (resource.data.residentId == request.auth.uid);
      allow delete: if isStaff() && isSameBarangay(resource.data.barangayId);
    }

    /**
     * @description Rules for the /payments/{paymentId} collection.
     * Payments are managed by staff within their barangay.
     */
    match /payments/{paymentId} {
      allow read: if isStaff() && isSameBarangay(resource.data.barangayId);
      allow write: if isStaff() && isSameBarangay(resource.data.barangayId) && hasValidBarangayId();
    }

    /**
     * @description Rules for the /officials/{officialId} collection.
     * Admins can manage officials within their barangay.
     */
    match /officials/{officialId} {
      allow read: if isAdmin() && isSameBarangay(resource.data.barangayId);
      allow write: if isAdmin() && isSameBarangay(resource.data.barangayId) && hasValidBarangayId();
    }

    /**
     * @description Rules for the /barangayConfig/{configId} collection (legacy).
     * Kept for backward compatibility. Redirects to /barangays collection.
     */
    match /barangayConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
